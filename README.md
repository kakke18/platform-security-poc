# platform-security-poc

マルチテナントSaaSプラットフォームのセキュリティ機能を検証するためのPoCプロジェクトです。

## 概要

本プロジェクトは、以下のセキュリティ機能を実装・検証します：

- **Auth0認証**: OAuth 2.0 / OIDC ベースの認証
- **特権ユーザー**: 運営者向けの特別な認証ルール
- **IPアドレス制限**: ワークスペース単位のホワイトリスト制限
- **レートリミット**: グローバル + ワークスペース単位の制限
- **監査ログ**: 認証・ユーザー管理・セキュリティ設定の操作ログ

## アーキテクチャ

```
┌─────────────┐
│   Client    │
│  (Next.js)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Gateway   │
│ (Go/Connect)│
└──────┬──────┘
       │
       ├─────────────────┬─────────────────┐
       ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ Identity API│   │ Project API │   │  Task API   │
│ (Go/Connect)│   │ (Go/Connect)│   │ (Go/Connect)│
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       │                 └────────┬────────┘
       │                          │
       ├──────────────────────────┤
       ▼                          ▼
┌─────────────┐            ┌─────────────┐
│   Auth0     │            │ PostgreSQL  │
└─────────────┘            └─────────────┘
                                 │
                  ┌──────────────┼──────────────┐
                  ▼              ▼              ▼
              identity_db   project_db     task_db
```

## 技術スタック

| コンポーネント | 技術 |
|----------------|------|
| Client | Next.js 15 (App Router) |
| Gateway | Go 1.25 / Connect |
| Identity API | Go 1.25 / Connect |
| Project API | Go 1.25 / Connect |
| Task API | Go 1.25 / Connect |
| Database | PostgreSQL 17 |
| 認証 | Auth0 |
| プロトコル | Connect (Protocol Buffers) |
| コンテナ | Docker / Docker Compose |

## ディレクトリ構成

```
platform-security-poc/
├── proto/                      # Protocol Buffers 定義
│   ├── identity/v1/
│   ├── project/v1/
│   └── task/v1/
├── client/                     # Next.js クライアント
├── gateway/                    # Go Gateway
├── identity-api/               # Identity API
├── project-api/                # Project API
├── task-api/                   # Task API
├── docker-compose.yml
├── Makefile
└── README.md
```

## サービス概要

### Identity API

認証・認可・ユーザー管理を担当するコアサービス。

| 機能 | 説明 |
|------|------|
| 認証 | Auth0連携によるログイン/ログアウト |
| ユーザー管理 | ユーザーのCRUD操作 |
| ワークスペース管理 | 認証ポリシー、IP制限、レートリミット設定 |
| 監査ログ | 操作履歴の記録・提供 |

### Project API

プロジェクト管理を担当するサンプルサービス。

| 機能 | 説明 |
|------|------|
| プロジェクト管理 | プロジェクトのCRUD操作 |
| メンバー管理 | プロジェクトメンバーの管理 |

### Task API

タスク管理を担当するサンプルサービス。

| 機能 | 説明 |
|------|------|
| タスク管理 | タスクのCRUD操作 |
| ステータス管理 | タスクの進捗管理 |

## セキュリティ機能

### 特権ユーザー

運営者向けの特別な認証ルール：

- 認証方式は `password_only` 固定
- IP制限から除外
- ワークスペースレートリミットから除外

### IPアドレス制限

ワークスペース単位でのホワイトリスト制限：

- CIDR表記対応（例: `192.168.1.0/24`）
- 特権ユーザーは除外
- 許可/拒否のログ出力

### レートリミット

2段階のレートリミット：

| レベル | 対象 | デフォルト |
|--------|------|------------|
| グローバル | 全リクエスト | 50,000 req/min |
| ワークスペース | 認証後リクエスト | 1,000 req/min |

### 監査ログ

以下の操作を記録：

- 認証: ログイン成功/失敗、ログアウト
- ユーザー管理: 作成、更新、削除
- セキュリティ管理: 認証ポリシー変更、IP制限変更、レートリミット変更
